<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skill Network Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-secondary: #1e1e1e;
            --text-primary: #ffffff;
            --accent-color: #FFA07A;
            --pastel-blue: #A7C7E7;
            --pastel-green: #98FB98;
            --connected-color: #98FB98;
            --pastel-yellow: #FFD700;
            --pastel-purple: #D8BFD8;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 10px;
            gap: 10px;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .container {
                flex-direction: row;
            }
        }

        .main-content {
            flex: 3;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .search-container {
            position: relative;
            margin-bottom: 10px;
            width: 100%;
            z-index: 10;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 6px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #333;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: var(--bg-secondary);
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #333;
        }

        .autocomplete-items div:hover {
            background-color: rgba(74, 158, 255, 0.1);
        }

        #network-container {
            flex-grow: 1;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            min-height: 300px;
        }

        #network-container svg {
            cursor: move;
            width: 100%;
            height: 100%;
        }

        .node circle {
            stroke: rgba(255,255,255,0.3);
            stroke-width: 2px;
            transition: transform 0.3s ease;
        }

        .node text {
            font-weight: bold;
            fill: var(--text-primary);
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none;
            font-size: 10px;
        }

        .link {
            stroke: rgba(255,255,255,0.2);
            stroke-width: 1.5px;
            transition: all 0.3s ease;
        }

        .node.highlighted circle {
            stroke: var(--accent-color);
            stroke-width: 3px;
            transform: scale(1.2);
        }

        .node.connected circle {
            fill: var(--connected-color) !important;
            stroke: var(--pastel-green);
            stroke-width: 2.5px;
        }

        .link.highlighted {
            stroke: var(--accent-color);
            stroke-width: 3px;
        }

        .connections-panel {
            flex: 1;
            min-width: 250px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            display: none;
            flex-direction: column;
            max-height: 100%;
            overflow: hidden;
        }

        @media (max-width: 767px) {
            .connections-panel {
                width: 100%;
                max-height: 300px;
            }
        }

        .connections-panel.visible {
            display: flex;
        }

        .connections-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto;
        }

        .connections-list li {
            padding: 10px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .connections-list li:hover {
            background-color: rgba(74, 158, 255, 0.1);
        }

        .connections-count {
            color: #666;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="search-container">
                <input type="text" id="search" placeholder="Search for skills...">
                <div class="autocomplete-items" id="autocomplete-list"></div>
            </div>
            <div id="network-container">
                <svg></svg>
            </div>
        </div>
        <div class="connections-panel" id="connections-panel">
            <h2>Connected Skills</h2>
            <div class="connections-count"></div>
            <ul class="connections-list"></ul>
        </div>
    </div>
    
    <script>
        let simulation;
        let svg, container, width, height, zoom;
        let networkData;
        let allSkills = [];

        async function loadSkills() {
            try {
                const response = await fetch('/api/skills');
                if (!response.ok) {
                    throw new Error('Failed to fetch skills');
                }
                allSkills = await response.json();
            } catch (error) {
                console.error('Error loading skills:', error);
                allSkills = []; 
            }
        }

        function autocomplete(input) {
            input.addEventListener("input", function(e) {
                const val = this.value.toLowerCase();
                const list = document.getElementById("autocomplete-list");
                list.innerHTML = '';

                if (!val) {
                    resetVisualization();
                    return;
                }

                const matches = allSkills.filter(skill => 
                    skill.toLowerCase().includes(val)
                ).slice(0, 10);

                matches.forEach(skill => {
                    const div = document.createElement("div");
                    div.textContent = skill;
                    div.addEventListener("click", () => {
                        input.value = skill;
                        list.innerHTML = '';
                        highlightSkill(skill);
                        showConnections(skill);
                    });
                    list.appendChild(div);
                });
            });

            document.addEventListener("click", function(e) {
                if (e.target !== input) {
                    document.getElementById("autocomplete-list").innerHTML = '';
                }
            });
        }

        function resetVisualization() {
            d3.selectAll('.node')
                .classed('highlighted', false)
                .classed('connected', false);
            
            d3.selectAll('.link')
                .classed('highlighted', false);
            
            document.getElementById('connections-panel').classList.remove('visible');
        }

        async function showConnections(skill) {
            try {
                const response = await fetch(`/api/connections/${encodeURIComponent(skill)}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch connections');
                }
                const connections = await response.json();
                
                const panel = document.getElementById('connections-panel');
                const list = panel.querySelector('.connections-list');
                const count = panel.querySelector('.connections-count');
                
                list.innerHTML = '';
                count.textContent = `${connections.length} connections`;
                
                connections.forEach(connection => {
                    const li = document.createElement('li');
                    li.textContent = connection;
                    li.title = connection;
                    li.addEventListener('click', () => {
                        document.getElementById('search').value = connection;
                        highlightSkill(connection);
                        showConnections(connection);
                    });
                    list.appendChild(li);
                });
                
                panel.classList.add('visible');
            } catch (error) {
                console.error('Error fetching connections:', error);
                const panel = document.getElementById('connections-panel');
                const list = panel.querySelector('.connections-list');
                list.innerHTML = '<li>Unable to load connections</li>';
                panel.classList.add('visible');
            }
        }

        function highlightSkill(skill) {
            // Reset previous highlighting
            d3.selectAll('.node')
                .classed('highlighted', false)
                .classed('connected', false);
            d3.selectAll('.link')
                .classed('highlighted', false);

            // Highlight selected skill
            d3.selectAll('.node')
                .filter(d => d.id === skill)
                .classed('highlighted', true);

            // Highlight connected skills
            d3.selectAll('.link')
                .filter(d => d.source.id === skill || d.target.id === skill)
                .classed('highlighted', true);

            // Highlight connected nodes with a different color
            const connectedNodes = new Set();
            d3.selectAll('.link')
                .filter(d => d.source.id === skill || d.target.id === skill)
                .each(d => {
                    connectedNodes.add(d.source.id === skill ? d.target.id : d.source.id);
                });

            d3.selectAll('.node')
                .filter(d => connectedNodes.has(d.id))
                .classed('connected', true);
        }

        async function initVisualization() {
            svg = d3.select("svg");
            svg.selectAll("*").remove();
            
            const container = document.getElementById('network-container');
            width = container.clientWidth;
            height = container.clientHeight;
            
            zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on("zoom", zoomed);
            
            svg.call(zoom);
            
            const networkContainer = svg.append("g");
            
            try {
                const response = await fetch('/api/network');
                if (!response.ok) {
                    throw new Error('Failed to fetch network data');
                }
                networkData = await response.json();
                
                simulation = d3.forceSimulation(networkData.nodes)
                    .force("charge", d3.forceManyBody().strength(-300))
                    .force("center", d3.forceCenter(width / 2, height / 2))
                    .force("collision", d3.forceCollide().radius(d => Math.sqrt(d.degree) * 4 + 10))
                    .force("link", d3.forceLink(networkData.edges).id(d => d.id).distance(100))
                    .on("tick", ticked);
                
                const link = networkContainer.selectAll(".link")
                    .data(networkData.edges)
                    .enter().append("line")
                    .attr("class", "link");
                
                const node = networkContainer.selectAll(".node")
                    .data(networkData.nodes)
                    .enter().append("g")
                    .attr("class", "node");
                
                node.append("circle")
                    .attr("r", d => Math.sqrt(d.degree) * 4 + 8)
                    .style("fill", "var(--pastel-blue)");
                
                node.append("text")
                    .text(d => d.id)
                    .attr("dy", "0.35em");
                
                function ticked() {
                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);
                    
                    node.attr("transform", d => `translate(${d.x},${d.y})`);
                }

                function zoomed(event) {
                    networkContainer.attr("transform", event.transform);
                }
            } catch (error) {
                console.error('Error initializing visualization:', error);
            }
        }

        async function init() {
            await loadSkills();
            await initVisualization();
            autocomplete(document.getElementById("search"));

            window.addEventListener('resize', () => {
                initVisualization();
            });
        }

        window.addEventListener("load", init);
    </script>
</body>
</html>
