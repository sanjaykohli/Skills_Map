<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skill Network Visualization</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-secondary: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #888;
            --border-color: #333;
            --node-primary: #3a3a3a;
            --node-secondary: #4a4a4a;
            --node-highlight: #607d8b;
            --link-color: rgba(96, 125, 139, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            padding: 20px;
            gap: 20px;
        }

        .main-content {
            flex: 3;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .search-container {
            position: relative;
            margin-bottom: 15px;
            z-index: 10;
        }

        .search-input {
            width: 100%;
            padding: 10px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-top: none;
            z-index: 99;
        }

        .autocomplete-list div {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }

        .autocomplete-list div:hover {
            background-color: rgba(96, 125, 139, 0.1);
        }

        #network-container {
            flex-grow: 1;
            background-color: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        #network-container svg {
            width: 100%;
            height: 100%;
        }

        .node circle {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .node text {
            font-weight: 600;
            fill: var(--text-primary);
            text-anchor: middle;
            dominant-baseline: middle;
            font-size: 10px;
            pointer-events: none;
        }

        .link {
            stroke: var(--link-color);
            stroke-width: 1.5px;
            transition: all 0.3s ease;
        }

        .node.selected circle {
            stroke: var(--node-highlight);
            stroke-width: 3px;
            fill: var(--node-highlight) !important;
        }

        .node.connected circle {
            fill: var(--node-secondary) !important;
            stroke: var(--text-primary);
            stroke-width: 2px;
        }

        .connections-panel {
            flex: 1;
            background-color: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            max-width: 350px;
        }

        .connections-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .connections-header h2 {
            margin: 0;
            font-size: 18px;
            color: var(--text-primary);
        }

        .connections-count {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .connections-list {
            list-style: none;
            overflow-y: auto;
            flex-grow: 1;
        }

        .connections-list li {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .connections-list li:hover {
            background-color: rgba(96, 125, 139, 0.1);
        }

        .connections-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="search-container">
                <input type="text" class="search-input" id="search" placeholder="Search for skills...">
                <div class="autocomplete-list" id="autocomplete-list"></div>
            </div>
            <div id="network-container">
                <svg></svg>
            </div>
        </div>
        <div class="connections-panel" id="connections-panel">
            <div class="connections-header">
                <h2>Skill Connections</h2>
                <div class="connections-count">0 connections</div>
            </div>
            <ul class="connections-list"></ul>
        </div>
    </div>
    
    <script>
        let simulation, svg, networkContainer, width, height, zoom;
        let networkData, allSkills = [];

        async function loadSkills() {
            try {
                const response = await fetch('/api/skills');
                allSkills = await response.json();
            } catch (error) {
                console.error('Error loading skills:', error);
            }
        }

        function setupAutocomplete() {
            const searchInput = document.getElementById('search');
            const autocompleteList = document.getElementById('autocomplete-list');

            searchInput.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                autocompleteList.innerHTML = '';

                if (!value) {
                    resetVisualization();
                    return;
                }

                const matches = allSkills.filter(skill => 
                    skill.toLowerCase().includes(value)
                ).slice(0, 10);

                matches.forEach(skill => {
                    const div = document.createElement('div');
                    div.textContent = skill;
                    div.addEventListener('click', () => {
                        searchInput.value = skill;
                        autocompleteList.innerHTML = '';
                        selectSkillByName(skill);
                    });
                    autocompleteList.appendChild(div);
                });
            });

            document.addEventListener('click', function(e) {
                if (e.target !== searchInput) {
                    autocompleteList.innerHTML = '';
                }
            });
        }

        function resetVisualization() {
            d3.selectAll('.node')
                .classed('selected', false)
                .classed('connected', false);
            
            const panel = document.getElementById('connections-panel');
            panel.querySelector('.connections-list').innerHTML = '';
            panel.querySelector('.connections-count').textContent = '0 connections';
        }

        function initVisualization() {
            svg = d3.select("#network-container svg");
            svg.selectAll("*").remove();
            
            const container = document.getElementById('network-container');
            width = container.clientWidth;
            height = container.clientHeight;
            
            zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on("zoom", (event) => {
                    networkContainer.attr("transform", event.transform);
                });
            
            networkContainer = svg.append("g");
            
            svg.call(zoom)
               .call(zoom.transform, d3.zoomIdentity);
            
            fetch('/api/network')
                .then(response => response.json())
                .then(data => {
                    networkData = data;
                    
                    simulation = d3.forceSimulation(networkData.nodes)
                        .force("charge", d3.forceManyBody().strength(-300))
                        .force("center", d3.forceCenter(width / 2, height / 2))
                        .force("collision", d3.forceCollide().radius(d => Math.sqrt(d.degree) * 4 + 10))
                        .force("link", d3.forceLink(networkData.edges).id(d => d.id).distance(100))
                        .on("tick", ticked);
                    
                    const link = networkContainer.selectAll(".link")
                        .data(networkData.edges)
                        .enter().append("line")
                        .attr("class", "link");
                    
                    const node = networkContainer.selectAll(".node")
                        .data(networkData.nodes)
                        .enter().append("g")
                        .attr("class", "node")
                        .on("click", selectSkill);
                    
                    node.append("circle")
                        .attr("r", d => Math.sqrt(d.degree) * 4 + 8)
                        .style("fill", "var(--node-primary)");
                    
                    node.append("text")
                        .text(d => d.id)
                        .attr("dy", "0.35em");
                    
                    function ticked() {
                        link
                            .attr("x1", d => d.source.x)
                            .attr("y1", d => d.source.y)
                            .attr("x2", d => d.target.x)
                            .attr("y2", d => d.target.y);
                        
                        node.attr("transform", d => `translate(${d.x},${d.y})`);
                    }
                });
        }

        function selectSkill(event, selectedSkill) {
            d3.selectAll('.node')
                .classed('selected', false)
                .classed('connected', false);
            d3.selectAll('.link')
                .style('opacity', 1);

            d3.select(event.currentTarget)
                .classed('selected', true);

            const connectedNodes = new Set();
            networkData.edges.forEach(edge => {
                if (edge.source.id === selectedSkill.id || edge.target.id === selectedSkill.id) {
                    const connectedSkill = edge.source.id === selectedSkill.id ? edge.target.id : edge.source.id;
                    connectedNodes.add(connectedSkill);
                }
            });

            updateConnectionsPanel(selectedSkill.id, Array.from(connectedNodes));

            d3.selectAll('.node')
                .filter(d => connectedNodes.has(d.id))
                .classed('connected', true);
        }

        function selectSkillByName(skillName) {
            const targetNode = d3.selectAll('.node').filter(d => d.id === skillName).node();
            if (targetNode && targetNode.__data__) {
                selectSkill({ currentTarget: targetNode }, targetNode.__data__);
            }
        }

        function updateConnectionsPanel(selectedSkill, connections) {
            const panel = document.getElementById('connections-panel');
            const list = panel.querySelector('.connections-list');
            const count = panel.querySelector('.connections-count');

            list.innerHTML = '';
            count.textContent = `${connections.length} connections`;

            connections.forEach(connection => {
                const li = document.createElement('li');
                li.textContent = connection;
                li.addEventListener('click', () => {
                    const targetNode = d3.selectAll('.node').filter(d => d.id === connection).node();
                    if (targetNode) {
                        targetNode.__data__ && selectSkill({ currentTarget: targetNode }, targetNode.__data__);
                    }
                });
                list.appendChild(li);
            });
        }

        async function init() {
            await loadSkills();
            setupAutocomplete();
            initVisualization();
        }

        window.addEventListener("load", init);
        window.addEventListener("resize", initVisualization);
    </script>
</body>
</html>
